<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sudoku Multi-Variante ‚Äì 4√ó4 ¬∑ 6√ó6 ¬∑ 8√ó8 ¬∑ 9√ó9 ¬∑ 12√ó12 ¬∑ 16√ó16</title>
<style>
  :root{
    --bg:#eef2f7; --card:#ffffff; --text:#0f172a; --muted:#475569; --ac:#0ea5e9;
    --grid:#1f2937; --shadow:0 8px 30px rgba(2,6,23,.08);
    --active:#0ea5e9; --activeText:#fff;
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#0b1324; --text:#e5e7eb; --muted:#9ca3af; --ac:#22d3ee;
    --grid:#374151; --shadow:0 12px 40px rgba(0,0,0,.35);
    --active:#22d3ee; --activeText:#0b1324;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .container{max-width:1120px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
  .tema{display:flex;align-items:center;gap:8px}
  select{padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:var(--card);color:var(--text)}

  .hero{background:linear-gradient(180deg,#1e3a8a,#1f6aa5);color:#fff;border-radius:16px;padding:22px 18px;box-shadow:var(--shadow)}
  .hero h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,38px)}
  .hero p{margin:0;opacity:.95}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:18px}
  .card{background:var(--card);border:1px solid #d1d5db;border-radius:14px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
  .card h3{margin:0}
  .logo{width:52px;height:52px;display:grid;place-items:center;border-radius:12px}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #0ea5e9;background:#e0f2fe;color:#075985;font-weight:600;cursor:pointer;width:max-content}

  .panel{background:var(--card);border:1px solid #d1d5db;border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .panel h2{margin:8px 0 10px;text-align:center;font-size:clamp(20px,3vw,34px)}
  .barra{display:flex;justify-content:flex-start;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  .boton{padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1;background:var(--card);cursor:pointer}
  .boton.ac{background:linear-gradient(135deg,#0891b2,#06b6d4);color:#fff;border-color:#0891b2;font-weight:700}
  .boton.ok{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;border-color:#16a34a;font-weight:700}
  .boton.warn{background:linear-gradient(135deg,#d97706,#f59e0b);color:#fff;border-color:#d97706;font-weight:700}
  .boton.active{background:var(--active);color:var(--activeText);border-color:var(--active)}

  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px}

  .sudoku{display:grid;width:min(92vw,560px);aspect-ratio:1;border:3px solid var(--grid);border-radius:10px;overflow:hidden}
  .cell{border:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center;background:var(--card);font-weight:700}
  [data-theme="dark"] .cell{border-color:#1f2937}
  .cell input{width:100%;height:100%;text-align:center;border:0;outline:0;background:transparent;color:inherit;font:inherit}
  .cell.fixed{background:#e2e8f0;color:#0f172a}
  [data-theme="dark"] .cell.fixed{background:#0f162b;color:#a5b4fc}
  .cell.err{background:rgba(239,68,68,.18)}
  .cell.hint{box-shadow:inset 0 0 0 3px rgba(34,211,238,.35)}
  .btop{border-top:3px solid var(--grid)} .bleft{border-left:3px solid var(--grid)}
  .bright{border-right:3px solid var(--grid)} .bbottom{border-bottom:3px solid var(--grid)}

  .indicadores{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;font-size:13px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:var(--card)}

  /* Modal ayuda */
  .help{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9000}
  .help.visible{display:flex}
  .help .box{background:var(--card);color:var(--text);max-width:720px;width:100%;padding:18px;border-radius:14px;border:1px solid #d1d5db;position:relative}
  .help .close{position:absolute;top:10px;right:10px}

  /* Modal GA */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal.visible{display:flex}
  .modal .box{background:var(--card);color:var(--text);max-width:840px;width:100%;padding:18px;border-radius:14px;border:1px solid #d1d5db;position:relative;box-shadow:var(--shadow)}
  .modal .close{position:absolute;top:10px;right:10px}
  canvas{width:100%;height:230px;background:var(--card);border:1px solid #d1d5db;border-radius:12px}

  footer{margin:22px 0 12px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body data-theme="light">
<div class="container">
  <header>
    <strong>üß© Sudoku Multi-Variante</strong>
    <div class="tema">
      <label for="temaSel">Tema</label>
      <select id="temaSel"><option>Claro</option><option>Oscuro</option></select>
    </div>
  </header>

  <!-- MEN√ö -->
  <section id="vistaMenu">
    <div class="hero">
      <h1>Sudoku Multi-Variante</h1>
      <p>4√ó4, 6√ó6, 8√ó8, 9√ó9, 12√ó12 y 16√ó16 (beta). Generaci√≥n por Algoritmo Gen√©tico con verificaci√≥n.</p>
    </div>

    <div class="grid">
      <!-- 4√ó4 -->
      <article class="card">
        <div class="logo" style="background:#dcfce7;border:1px solid #86efac">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="6" y="6" width="24" height="24" rx="4" stroke="#16a34a" stroke-width="2"/>
            <path d="M18 6v24M6 18h24" stroke="#16a34a" stroke-width="2"/>
            <text x="10" y="14" font-size="8" fill="#16a34a" font-family="monospace">4√ó4</text>
          </svg>
        </div>
        <h3>Mini 4√ó4</h3>
        <p>Subcuadros 2√ó2.</p>
        <button class="btn" data-jugar="4">Jugar Ahora</button>
      </article>

      <!-- 6√ó6 -->
      <article class="card">
        <div class="logo" style="background:#ecfeff;border:1px solid #67e8f9">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="4" y="4" width="28" height="28" rx="4" stroke="#0891b2" stroke-width="2"/>
            <text x="10" y="14" font-size="8" fill="#0891b2" font-family="monospace">6√ó6</text>
          </svg>
        </div>
        <h3>6√ó6</h3>
        <p>Subcuadros 2√ó3.</p>
        <button class="btn" data-jugar="6">Jugar Ahora</button>
      </article>

      <!-- 8√ó8 -->
      <article class="card">
        <div class="logo" style="background:#fff7ed;border:1px solid #fdba74">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="5" y="5" width="26" height="26" rx="4" stroke="#ea580c" stroke-width="2"/>
            <text x="9" y="21" font-size="10" fill="#ea580c" font-family="monospace">8√ó8</text>
          </svg>
        </div>
        <h3>8√ó8</h3>
        <p>Subcuadros 2√ó4.</p>
        <button class="btn" data-jugar="8">Jugar Ahora</button>
      </article>

      <!-- 9√ó9 -->
      <article class="card">
        <div class="logo" style="background:#e0f2fe;border:1px solid #7dd3fc">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="3" y="3" width="30" height="30" rx="4" stroke="#0284c7" stroke-width="2"/>
            <path d="M15 3v30M21 3v30M3 15h30M3 21h30" stroke="#0284c7" stroke-width="2"/>
          </svg>
        </div>
        <h3>Cl√°sico 9√ó9</h3>
        <p>Subcuadros 3√ó3.</p>
        <button class="btn" data-jugar="9">Jugar Ahora</button>
      </article>

      <!-- 12√ó12 -->
      <article class="card">
        <div class="logo" style="background:#fef3c7;border:1px solid #fcd34d">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="5" y="5" width="26" height="26" rx="4" stroke="#d97706" stroke-width="2"/>
            <text x="7" y="12" font-size="8" fill="#d97706" font-family="monospace">12√ó12</text>
          </svg>
        </div>
        <h3>12√ó12</h3>
        <p>Subcuadros 3√ó4.</p>
        <button class="btn" data-jugar="12">Jugar Ahora</button>
      </article>

      <!-- 16√ó16 -->
      <article class="card">
        <div class="logo" style="background:#f5f3ff;border:1px solid #c4b5fd">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="4" y="4" width="28" height="28" rx="4" stroke="#6d28d9" stroke-width="2"/>
            <text x="9" y="21" font-size="10" fill="#6d28d9" font-family="monospace">16</text>
          </svg>
        </div>
        <h3>16√ó16 (beta)</h3>
        <p>Subcuadros 4√ó4.</p>
        <button class="btn" data-jugar="16">Jugar Ahora</button>
      </article>
    </div>
  </section>

  <!-- JUEGO -->
  <section id="vistaJuego" style="display:none">
    <div class="panel">
      <div class="barra">
        <button class="boton" id="volverMenu">‚Üê Volver al Men√∫</button>
        <button class="boton" id="comoJugar">C√≥mo Jugar</button>
        <button class="boton warn" id="btnMonitor">Monitor GA</button>
        <button class="boton ok" id="btnBenchmark">Validar AG</button>
      </div>
      <h2 id="tituloJuego">Sudoku</h2>
      <p id="descJuego" style="text-align:center;margin-top:-4px;margin-bottom:10px;color:#475569">
        Selecciona dificultad y pulsa ‚ÄúIniciar juego‚Äù.
      </p>

      <div class="barra" style="justify-content:center">
        <strong>Selecciona Dificultad:</strong>
        <button class="boton dif" data-dif="facil">F√°cil</button>
        <button class="boton dif" data-dif="media">Medio</button>
        <button class="boton dif" data-dif="dificil">Dif√≠cil</button>
        <button class="boton dif" data-dif="experto">Experto</button>
        <button class="boton ac" id="iniciarJuego">Iniciar juego</button>
      </div>

      <div class="wrap">
        <div id="tablero" class="sudoku" aria-label="Tablero Sudoku"></div>

        <div class="barra" style="justify-content:center">
          <button class="boton" id="btnVerificar">Verificar</button>
          <button class="boton ok" id="btnResolver">Mostrar soluci√≥n</button>
          <button class="boton" id="btnReiniciar">Reiniciar</button>
          <button class="boton" id="btnDeshacer">Deshacer</button>
          <button class="boton" id="btnRehacer">Rehacer</button>
          <button class="boton" id="btnNuevo">Nuevo Juego</button>
          <button class="boton" id="btnPista">Pista</button>
        </div>

        <div class="indicadores">
          <span class="pill" id="estadoValidez">Estado: ‚Äî</span>
          <span class="pill" id="reloj">‚è±Ô∏è 00:00</span>
          <span class="pill" id="pistasUsadas">Pistas usadas: 0</span>
        </div>
      </div>
    </div>
  </section>

  <footer>Sudoku Multi-Variante ¬© 2025 ‚Äî Desarrollado con ‚ù§</footer>
</div>

<!-- MODAL AYUDA -->
<div id="modalAyuda" class="help" aria-hidden="true">
  <div class="box">
    <button class="boton close" id="cerrarAyuda">Cerrar</button>
    <h3 id="ayudaTitulo">C√≥mo jugar</h3>
    <div id="ayudaContenido">
      <p>Haz clic en una celda y escribe el n√∫mero. No se permiten repeticiones en <b>fila</b>, <b>columna</b> ni <b>subcuadro</b>.</p>
      <ul>
        <li>El tablero se genera tras elegir dificultad y pulsar <b>Iniciar juego</b>.</li>
        <li>Usa <em>Pista</em>, <em>Deshacer/Rehacer</em> y <em>Verificar</em> cuando necesites.</li>
        <li>El cron√≥metro empieza al iniciar la partida.</li>
      </ul>
    </div>
  </div>
</div>

<!-- MODAL MONITOR GA -->
<div id="modalGA" class="modal" aria-hidden="true">
  <div class="box">
    <button class="boton close" id="cerrarGA">Cerrar</button>
    <h3>üß¨ Monitor Algoritmo Gen√©tico</h3>
    <p id="gaInfo" style="margin:6px 0 10px;color:#475569">Listo‚Ä¶</p>
    <canvas id="graficoGA"></canvas>
    <pre id="logGA" style="height:200px;overflow:auto;margin-top:10px;background:var(--card);border:1px solid #d1d5db;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px"></pre>
  </div>
</div>

<script>
/* ===== Tema ===== */
const root=document.body, temaSel=document.getElementById('temaSel');
function setTema(m){root.setAttribute('data-theme',m==='Oscuro'?'dark':'light');localStorage.setItem('temaSudoku',m)}
temaSel.value=localStorage.getItem('temaSudoku')||'Claro';setTema(temaSel.value);
temaSel.addEventListener('change',e=>setTema(e.target.value));

/* ===== Navegaci√≥n / Config ===== */
const vistaMenu=document.getElementById('vistaMenu');
const vistaJuego=document.getElementById('vistaJuego');
const tableroDiv=document.getElementById('tablero');

let tamano=9, subR=3, subC=3, dificultad='media';
const TITULOS={4:['Mini 4√ó4','Subcuadros 2√ó2.'],
               6:['Sudoku 6√ó6','Subcuadros 2√ó3.'],
               8:['Sudoku 8√ó8','Subcuadros 2√ó4.'],
               9:['Cl√°sico 9√ó9','Subcuadros 3√ó3.'],
               12:['Sudoku 12√ó12','Subcuadros 3√ó4.'],
               16:['Sudoku 16√ó16 (beta)','Subcuadros 4√ó4.']};
const SUBREGIONES={4:[2,2],6:[2,3],8:[2,4],9:[3,3],12:[3,4],16:[4,4]};

document.querySelectorAll('.btn[data-jugar]').forEach(b=>{
  b.addEventListener('click',()=>{
    tamano=parseInt(b.getAttribute('data-jugar'),10);
    [subR,subC]=SUBREGIONES[tamano];
    document.getElementById('tituloJuego').textContent=TITULOS[tamano][0];
    document.getElementById('descJuego').textContent=TITULOS[tamano][1];
    vistaMenu.style.display='none'; vistaJuego.style.display='block';
    construirTableroVacio();
  });
});
document.getElementById('volverMenu').addEventListener('click',()=>{vistaJuego.style.display='none';vistaMenu.style.display='block'});

/* Dificultad marcada */
let difBtns=[...document.querySelectorAll('.dif')];
function setDifActive(key){dificultad=key;difBtns.forEach(b=>b.classList.toggle('active', b.getAttribute('data-dif')===key))}
difBtns.forEach(b=>b.addEventListener('click',()=>setDifActive(b.getAttribute('data-dif'))));
setDifActive('media');

/* Modales */
const modalAyuda=document.getElementById('modalAyuda'), modalGA=document.getElementById('modalGA');
document.getElementById('comoJugar').addEventListener('click',()=>modalAyuda.classList.add('visible'));
document.getElementById('cerrarAyuda').addEventListener('click',()=>modalAyuda.classList.remove('visible'));
modalAyuda.addEventListener('click',e=>{ if(e.target===modalAyuda) modalAyuda.classList.remove('visible'); });

document.getElementById('btnMonitor').addEventListener('click',()=>{modalGA.classList.add('visible'); resizeGA();});
document.getElementById('cerrarGA').addEventListener('click',()=>modalGA.classList.remove('visible'));
modalGA.addEventListener('click',e=>{ if(e.target===modalGA) modalGA.classList.remove('visible'); });

/* ===== Utilidades ===== */
const rango=n=>[...Array(n).keys()];
const copiar=m=>m.map(f=>f.slice());
const aleatorio=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;

/* ===== Reglas ===== */
function validoEn(m,f,c,v){
  for(let i=0;i<tamano;i++){ if(m[f][i]===v||m[i][c]===v) return false; }
  const r0=Math.floor(f/subR)*subR, c0=Math.floor(c/subC)*subC;
  for(let r=r0;r<r0+subR;r++) for(let k=c0;k<c0+subC;k++){ if(m[r][k]===v) return false; }
  return true;
}

/* ===== GA ‚Äì utilidades ===== */
function crearIndividuo(){
  // filas = permutaciones (1..N barajado) -> garantiza filas v√°lidas
  const base=rango(tamano).map(()=>rango(tamano).map(i=>i+1));
  for(let f=0;f<tamano;f++)
    for(let i=tamano-1;i>0;i--){const j=aleatorio(0,i); [base[f][i],base[f][j]]=[base[f][j],base[f][i]]}
  return base;
}
function conflictos(m){
  let conf=0;
  // columnas
  for(let c=0;c<tamano;c++){
    const cnt=Array(tamano+1).fill(0);
    for(let f=0;f<tamano;f++) cnt[m[f][c]]++;
    for(let v=1;v<=tamano;v++) if(cnt[v]>1) conf+=(cnt[v]-1);
  }
  // subcuadros
  for(let r0=0;r0<tamano;r0+=subR){
    for(let c0=0;c0<tamano;c0+=subC){
      const cnt=Array(tamano+1).fill(0);
      for(let r=r0;r<r0+subR;r++) for(let c=c0;c<c0+subC;c++) cnt[m[r][c]]++;
      for(let v=1;v<=tamano;v++) if(cnt[v]>1) conf+=(cnt[v]-1);
    }
  }
  return conf;
}
function mutar(ind,pm){
  for(let f=0;f<tamano;f++)
    if(Math.random()<pm){const a=aleatorio(0,tamano-1),b=aleatorio(0,tamano-1);[ind[f][a],ind[f][b]]=[ind[f][b],ind[f][a]]}
}
function cruzar(p,m){
  // cruce por fila: mantiene filas como permutaciones
  const h=rango(tamano).map(()=>Array(tamano).fill(0));
  for(let f=0;f<tamano;f++){const up=Math.random()<0.5;for(let c=0;c<tamano;c++)h[f][c]=up?p[f][c]:m[f][c]}
  return h;
}

/* Reparaci√≥n: swaps en la misma fila para corregir duplicados de columna sin romper subcuadros */
function repararColumnas(ind){
  for(let c=0;c<tamano;c++){
    const cnt=Array(tamano+1).fill(0);
    for(let f=0;f<tamano;f++) cnt[ind[f][c]]++;
    const faltan=[]; for(let v=1;v<=tamano;v++) if(cnt[v]===0) faltan.push(v);
    if(!faltan.length) continue;

    const dupRows=[]; const seen=Array(tamano+1).fill(false);
    for(let f=0;f<tamano;f++){ const v=ind[f][c]; if(seen[v]) dupRows.push(f); else seen[v]=true; }

    for(let i=0;i<dupRows.length && faltan.length;i++){
      const f=dupRows[i];
      for(let k=0;k<faltan.length;k++){
        const vNeed=faltan[k];
        let c2=-1; for(let cc=0;cc<tamano;cc++) if(ind[f][cc]===vNeed){c2=cc;break}
        if(c2===-1) continue;

        const r0=Math.floor(f/subR)*subR, c0=Math.floor(c/subC)*subC;
        let ok1=true; for(let r=r0;r<r0+subR;r++) for(let cc=c0;cc<c0+subC;cc++) if(cc!==c && ind[r][cc]===vNeed){ok1=false;break}
        const vCur=ind[f][c]; const rc0=Math.floor(c2/subC)*subC;
        let ok2=true; for(let r=r0;r<r0+subR;r++) for(let cc=rc0;cc<rc0+subC;cc++) if(cc!==c2 && ind[r][cc]===vCur){ok2=false;break}
        let okCol2=true; for(let r=0;r<tamano;r++) if(r!==f && ind[r][c2]===vCur){okCol2=false;break}

        if(ok1 && ok2 && okCol2){
          [ind[f][c],ind[f][c2]]=[ind[f][c2],ind[f][c]];
          faltan.splice(k,1);
          break;
        }
      }
    }
  }
}

function torneo(evals){const pick=()=>evals[aleatorio(0,evals.length-1)];return [pick(),pick(),pick()].sort((a,b)=>a.fit-b.fit)[0]}
function parametrosGA(N){
  if(N<=6) return {tamP:140,pm:0.10,elit:10,maxGen:800};
  if(N<=9) return {tamP:240,pm:0.12,elit:12,maxGen:1400};
  if(N<=12) return {tamP:300,pm:0.12,elit:12,maxGen:2200};
  return {tamP:900,pm:0.20,elit:10,maxGen:8000}; // 16√ó16 reforzado
}

/* ---- versi√≥n sincr√≥nica (benchmark) ---- */
function evolucionarGA(opts){
  const {tamP,pm,elit,maxGen,onTick}=opts;
  let pob=rango(tamP).map(()=>crearIndividuo());
  let mejor=null,mejorFit=Infinity;const elite=Math.max(1,Math.floor(elit/100*tamP));
  for(let gen=0;gen<maxGen;gen++){
    const evals=pob.map(ind=>({ind,fit:conflictos(ind)})).sort((a,b)=>a.fit-b.fit);
    if(evals[0].fit<mejorFit){mejorFit=evals[0].fit;mejor=copiar(evals[0].ind)}
    onTick&&onTick({gen,best:evals[0].fit});
    if(evals[0].fit===0) return {sol:copiar(evals[0].ind),gens:gen+1,fit:0};
    const nueva=[];for(let i=0;i<elite;i++)nueva.push(copiar(evals[i].ind));
    while(nueva.length<tamP){const a=torneo(evals),b=torneo(evals);let h=cruzar(a.ind,b.ind);mutar(h,pm);repararColumnas(h);nueva.push(h)}
    pob=nueva;
  }
  return {sol:mejor,gens:maxGen,fit:mejorFit};
}

/* ---- versi√≥n AS√çNCRONA (MUESTRA TODO EL PROCESO) ---- */
const sleepFrame = () => new Promise(requestAnimationFrame);
async function evolucionarGAAsync(opts){
  const {tamP,pm,elit,maxGen,onTick}=opts;
  let pob=rango(tamP).map(()=>crearIndividuo());
  let mejor=null,mejorFit=Infinity;const elite=Math.max(1,Math.floor(elit/100*tamP));

  for(let gen=0;gen<maxGen;gen++){
    const evals=pob.map(ind=>({ind,fit:conflictos(ind)})).sort((a,b)=>a.fit-b.fit);
    if(evals[0].fit<mejorFit){mejorFit=evals[0].fit;mejor=copiar(evals[0].ind)}
    onTick&&onTick({gen,best:evals[0].fit}); // ¬°se ve en tiempo real!
    if(gen%1===0) await sleepFrame();       // cede al navegador en CADA generaci√≥n

    if(evals[0].fit===0) return {sol:copiar(evals[0].ind),gens:gen+1,fit:0};

    const nueva=[];
    for(let i=0;i<elite;i++) nueva.push(copiar(evals[i].ind));
    while(nueva.length<tamP){
      const a=torneo(evals), b=torneo(evals);
      let h=cruzar(a.ind,b.ind);
      mutar(h,pm);
      repararColumnas(h);
      nueva.push(h);
    }
    pob=nueva;
  }
  return {sol:mejor,gens:maxGen,fit:mejorFit};
}

/* ===== Patr√≥n latino (fallback 100% v√°lido) ===== */
function solucionPatron(){
  const N=tamano, g=rango(N).map(()=>Array(N).fill(0));
  for(let r=0;r<N;r++) for(let c=0;c<N;c++) g[r][c]=( (r*subC + Math.floor(r/subR) + c) % N ) + 1;
  const rndPerm = arr => {for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr};
  const map=Array(N+1).fill(0); const perm=rndPerm(rango(N).map(i=>i+1));
  for(let v=1;v<=N;v++) map[v]=perm[v-1];
  for(let r=0;r<N;r++) for(let c=0;c<N;c++) g[r][c]=map[g[r][c]];
  for(let rb=0;rb<N;rb+=subR){const idx=rndPerm(rango(subR));const tmp=g.slice(rb,rb+subR).map(r=>r.slice()); for(let i=0;i<subR;i++) g[rb+i]=tmp[idx[i]];}
  for(let cb=0;cb<N;cb+=subC){const idx=rndPerm(rango(subC));const tmp=rango(N).map(r=>g[r].slice(cb,cb+subC)); for(let r=0;r<N;r++){for(let i=0;i<subC;i++) g[r][cb+i]=tmp[r][idx[i]];}}
  return g;
}

/* ===== Backtracking / unicidad ===== */
function resolverBT(m){
  const g=copiar(m);
  function buscar(){for(let f=0;f<tamano;f++)for(let c=0;c<tamano;c++)if(g[f][c]===0)return[f,c];return null}
  function aux(){const v=buscar();if(!v)return true;const[f,c]=v;for(let x=1;x<=tamano;x++){if(validoEn(g,f,c,x)){g[f][c]=x;if(aux())return true;g[f][c]=0}}return false}
  const ok=aux();return{ok,sol:ok?g:null};
}
function contarSoluciones(m,lim=2){
  let cnt=0;const g=copiar(m);
  function buscar(){for(let f=0;f<tamano;f++)for(let c=0;c<tamano;c++)if(g[f][c]===0)return[f,c];return null}
  function aux(){if(cnt>=lim)return;const v=buscar();if(!v){cnt++;return}const[f,c]=v;for(let x=1;x<=tamano;x++){if(validoEn(g,f,c,x)){g[f][c]=x;aux();g[f][c]=0;if(cnt>=lim)return}}}
  aux();return cnt;
}

/* ===== Crear puzzle (unicidad hasta 12√ó12; carving seguro para 16√ó16) ===== */
function crearPuzzle(sol){
  const tot=tamano*tamano;
  const objetivo = (dificultad==='facil')?Math.round(tot*0.55):
                   (dificultad==='media')?Math.round(tot*0.45):
                   (dificultad==='dificil')?Math.round(tot*0.36):Math.round(tot*0.30);
  const puz=copiar(sol); let visibles=tot;
  const pos=rango(tot).map(i=>[Math.floor(i/tamano),i%tamano]);
  for(let i=pos.length-1;i>0;i--){const j=aleatorio(0,i);[pos[i],pos[j]]=[pos[j],pos[i]]}
  const unicidad= tamano<=12;
  for(const [f,c] of pos){
    if(visibles<=objetivo)break;
    const f2=tamano-1-f, c2=tamano-1-c;
    const t1=puz[f][c], t2=puz[f2][c2];
    puz[f][c]=0; puz[f2][c2]=0;
    if(unicidad){
      if(contarSoluciones(puz,2)!==1){puz[f][c]=t1; puz[f2][c2]=t2}
      else {visibles-=(f===f2&&c===c2)?1:2}
    }else{
      visibles-=(f===f2&&c===c2)?1:2;
    }
  }
  return puz;
}

/* ===== Estado & UI ===== */
let tablero=rango(tamano).map(()=>Array(tamano).fill(0));
let fijas=rango(tamano).map(()=>Array(tamano).fill(false));
let solucion=null, pistas=0, undo=[], redo=[];
let seg=0, relojInt=null;

function construirTableroVacio(){
  tablero=rango(tamano).map(()=>Array(tamano).fill(0));
  fijas=rango(tamano).map(()=>Array(tamano).fill(false));
  pintar();
}
function pintar(){
  tableroDiv.innerHTML='';
  tableroDiv.style.gridTemplateColumns=`repeat(${tamano},1fr)`;
  for(let f=0;f<tamano;f++){
    for(let c=0;c<tamano;c++){
      const d=document.createElement('div');d.className='cell';
      if(f%subR===0)d.classList.add('btop'); if(c%subC===0)d.classList.add('bleft');
      if((c%subC)==subC-1)d.classList.add('bright'); if((f%subR)==subR-1)d.classList.add('bbottom');
      const inp=document.createElement('input');inp.maxLength=(tamano<=9)?1:2;inp.setAttribute('inputmode','numeric');
      inp.addEventListener('input',e=>{
        let txt=e.target.value.replace(/[^\d]/g,'');
        if(tamano<=9){txt=txt.replace(/[^1-9]/g,'')} else { if(parseInt(txt||"0",10)>tamano) txt=String(tamano); }
        e.target.value=txt; const val=txt?parseInt(txt,10):0;
        const idx=[...tableroDiv.querySelectorAll('input')].indexOf(e.target);
        const rf=Math.floor(idx/tamano), rc=idx%tamano;
        if(!fijas[rf][rc]){ pushUndo(); tablero[rf][rc]=val; validarUI(); }
        else e.target.value=tablero[rf][rc]||'';
      });
      if(tablero[f][c]) inp.value=String(tablero[f][c]);
      if(fijas[f][c]) d.classList.add('fixed');
      d.appendChild(inp); tableroDiv.appendChild(d);
    }
  }
  validarUI();
}
function validarUI(){
  const inputs=[...tableroDiv.querySelectorAll('input')]; let err=0;
  for(let f=0;f<tamano;f++)for(let c=0;c<tamano;c++){
    const cell=inputs[f*tamano+c].parentElement; cell.classList.remove('err');
    const v=tablero[f][c]; if(!v)continue; tablero[f][c]=0; const ok=validoEn(tablero,f,c,v); tablero[f][c]=v; if(!ok){cell.classList.add('err');err++}
  }
  document.getElementById('estadoValidez').textContent=err?`Estado: ‚ö†Ô∏è ${err} conflicto(s)`:'Estado: ‚úÖ sin conflictos locales';
}
function iniciarReloj(){detenerReloj();seg=0;tick();relojInt=setInterval(()=>{seg++;tick()},1000)}
function detenerReloj(){if(relojInt)clearInterval(relojInt)}
function tick(){const m=String(Math.floor(seg/60)).padStart(2,'0');const s=String(seg%60).padStart(2,'0');document.getElementById('reloj').textContent=`‚è±Ô∏è ${m}:${s}`}

function reiniciar(){
  for(let f=0;f<tamano;f++)for(let c=0;c<tamano;c++)if(!fijas[f][c])tablero[f][c]=0;
  pistas=0; document.getElementById('pistasUsadas').textContent='Pistas usadas: 0'; undo=[]; redo=[]; iniciarReloj(); pintar();
}
function verificar(){
  for(let f=0;f<tamano;f++)for(let c=0;c<tamano;c++)if(tablero[f][c]===0){alert('A√∫n hay celdas vac√≠as');return}
  const ok=JSON.stringify(tablero)===JSON.stringify(solucion);
  if(ok){detenerReloj();alert(`‚úÖ ¬°Completado! Tiempo ${document.getElementById('reloj').textContent.replace('‚è±Ô∏è ','')}`)}
  else alert('‚ùå Hay errores, revisa las celdas en rojo');
}
function pista(){
  if(!solucion){alert('Primero inicia el juego');return}
  const vac=[];for(let f=0;f<tamano;f++)for(let c=0;c<tamano;c++)if(tablero[f][c]===0)vac.push([f,c]);
  if(!vac.length){alert('No hay celdas vac√≠as');return}
  const [f,c]=vac[aleatorio(0,vac.length-1)];
  tablero[f][c]=solucion[f][c]; fijas[f][c]=true; pistas++;
  document.getElementById('pistasUsadas').textContent=`Pistas usadas: ${pistas}`;
  const el=tableroDiv.children[f*tamano+c]; el.classList.add('hint'); setTimeout(()=>el.classList.remove('hint'),900);
  pintar();
}
function pushUndo(){undo.push(JSON.stringify(tablero)); if(undo.length>120)undo.shift(); redo=[]}
function deshacer(){if(!undo.length)return; redo.push(JSON.stringify(tablero)); tablero=JSON.parse(undo.pop()); pintar()}
function rehacer(){if(!redo.length)return; undo.push(JSON.stringify(tablero)); tablero=JSON.parse(redo.pop()); pintar()}
document.getElementById('btnDeshacer').addEventListener('click',deshacer);
document.getElementById('btnRehacer').addEventListener('click',rehacer);

/* ===== Monitor GA (gr√°fica y log) ===== */
const canvas=document.getElementById('graficoGA'); const ctx=canvas.getContext('2d'); let fit=[];
function resizeGA(){ const w=canvas.width=canvas.clientWidth*devicePixelRatio; const h=canvas.height=230*devicePixelRatio; ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,w,h); drawGA(); }
function resetGA(){fit=[];resizeGA();document.getElementById('logGA').textContent='';document.getElementById('gaInfo').textContent='Listo‚Ä¶'}
function logGA(m){const el=document.getElementById('logGA'); el.textContent+=m+"\n"; el.scrollTop=el.scrollHeight}
function drawGA(){
  if(!fit.length)return;
  const w=canvas.width,h=canvas.height,pad=24,max=Math.max(...fit),min=Math.min(...fit);
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle='#334155';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pad,h-pad);ctx.lineTo(w-pad,h-pad);ctx.lineTo(w-pad,pad);ctx.stroke();
  ctx.beginPath();ctx.strokeStyle='#22d3ee';ctx.lineWidth=3;
  fit.forEach((v,i)=>{const x=pad+(i/(fit.length-1||1))*(w-2*pad);const y=h-pad-((v-min)/((max-min)||1))*(h-2*pad); i?ctx.lineTo(x,y):ctx.moveTo(x,y)});ctx.stroke();
}
window.addEventListener('resize',()=>{ if(modalGA.classList.contains('visible')) resizeGA(); });

/* ===== Generar / Resolver ===== */
async function generarConGA(){
  resetGA();
  const info=document.getElementById('gaInfo');
  info.textContent=`GA para ${tamano}√ó${tamano} (sub ${subR}√ó${subC})‚Ä¶`;
  const t0=performance.now();
  const params=parametrosGA(tamano);
  // --- versi√≥n as√≠ncrona: muestra TODO el proceso ---
  const res=await evolucionarGAAsync({
    ...params,
    onTick:({gen,best})=>{
      fit.push(best);            // cada gen
      drawGA();
      if(gen===0 || gen%1===0){  // log de TODAS las gens
        logGA(`Gen ${gen} | mejor=${best}`);
      }
    }
  });
  logGA(`Fin GA en ${(performance.now()-t0).toFixed(0)} ms (best=${res.fit})`);
  let base=res.sol;
  if(conflictos(base)!==0){
    logGA('‚ö†Ô∏è GA no lleg√≥ a fitness 0. Usando patr√≥n latino como respaldo.');
    base=solucionPatron();
  }
  solucion=base;
  const puzzle=crearPuzzle(solucion);
  tablero=copiar(puzzle);
  fijas=rango(tamano).map(()=>rango(tamano).map(()=>false));
  for(let f=0;f<tamano;f++) for(let c=0;c<tamano;c++) if(puzzle[f][c]!==0) fijas[f][c]=true;
  pistas=0; document.getElementById('pistasUsadas').textContent='Pistas usadas: 0'; undo=[]; redo=[];
  iniciarReloj(); pintar();
}
function mostrarSol(){ if(!solucion){alert('Primero inicia el juego');return} tablero=copiar(solucion); fijas=rango(tamano).map(()=>rango(tamano).map(()=>true)); detenerReloj(); pintar(); }

/* ===== Benchmark / Validaci√≥n AG (sincr√≥nico, r√°pido) ===== */
document.getElementById('btnBenchmark').addEventListener('click',()=>{
  const runs = 6, info = []; const params=parametrosGA(tamano);
  for(let r=0;r<runs;r++){
    const tStart=performance.now();
    const res=evolucionarGA({ ...params, onTick:()=>{} });
    const ok = conflictos(res.sol)===0; // √©xito real del GA (sin fallback)
    const t=performance.now()-tStart;
    info.push({gens:res.gens,ms:Math.round(t),ok});
  }
  const okc=info.filter(x=>x.ok).length;
  const avgG=Math.round(info.reduce((s,x)=>s+x.gens,0)/info.length);
  const avgT=Math.round(info.reduce((s,x)=>s+x.ms,0)/info.length);
  alert(`Validaci√≥n AG (${tamano}√ó${tamano})\n√âxitos (fitness 0): ${okc}/${runs}\nGeneraciones promedio: ${avgG}\nTiempo promedio: ${avgT} ms`);
});

/* ===== Inicializaci√≥n y botones ===== */
function init(){
  construirTableroVacio();
  document.getElementById('iniciarJuego').addEventListener('click',generarConGA);
  document.getElementById('btnNuevo').addEventListener('click',generarConGA);
  document.getElementById('btnResolver').addEventListener('click',mostrarSol);
  document.getElementById('btnPista').addEventListener('click',pista);
  document.getElementById('btnReiniciar').addEventListener('click',reiniciar);
  document.getElementById('btnVerificar').addEventListener('click',verificar);
}
init();
</script>
</body>
</html>
